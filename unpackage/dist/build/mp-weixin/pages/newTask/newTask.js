"use strict";const e=require("../../common/vendor.js"),t=require("../../common/Task.js"),s={data:()=>({counter:1,results:[],tasks:[{id:0,branchid:1,description:"",finishtime:"",deadline:(new Date).toISOString().slice(0,10),publishtime:"0001-01-01T00:00:00",fixedReward:0,percentReward:1e4,rewardtype:t.RewardType.Percent,status:t.TaskStatus.WaitForAccept,title:"",canTake:0,tag:"",verify:0,main:1,tag:""}],reffer:"",$mode:""}),computed:{taskTypes(){return this.$store.state.taskTypes},mode(){return this.$data.$mode}},created(e){console.log("created"),console.log(e)},onLoad(e){console.log("onload");let t=e.createType,s=e.branchid;this.$data.$mode=e.mode,console.log("reffer",t),console.log("branchType",s),this.tasks[0].branchid=s},methods:{getUuid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})).replace("-",""),backEvent(){this.tasks.length>0?e.index.showModal({content:"返回后以编辑的内容将会消失，是否放弃修改。",success:function(t){t.confirm?e.index.navigateBack():t.cancel&&console.log("用户点击取消")}}):e.index.navigateBack()},checkResult(e){this.results.push(e)},showModal:async()=>new Promise(((t,s)=>{e.index.showModal({showCancel:!1,title:"提示",content:"还有比例未分配完整。",success:function(e){e.confirm?t():e.cancel&&s(new Error("用户取消操作"))},fail:function(e){s(e)}})})),async submitEvent(){if(1e4!==this.tasks.reduce(((e,s)=>s.rewardtype===t.RewardType.Percent&&0===s.main?e+s.percentReward:e),0))try{return void(await this.showModal())}catch(s){}this.$store.commit("setPublishResults",[]);for(let e of this.tasks)this.$refs["id"+e.id][0].check();if(this.results.length>0&&this.results.every((e=>Boolean(e)))){let t=this.$store.state.apiBaseUrl+"/api/Assignment/posts";e.index.requestWithCookie({url:t,method:"POST",data:this.tasks,success:e=>{201===e.statusCode?this.$store.state.$publishResults.push({success:!0,message:"任务发布成功",errMsg:"ok",id:e.data.id}):this.$store.state.$publishResults.push({success:!1,message:"任务发布失败",errMsg:"server error"})},complete(){this.results=[]}}),e.index.navigateTo({url:"/pages/publishResult/publishResult"})}},rewardType(e){let s=this.$store.getters.getTaskType(e);return"only fixed"===s.rewardType?t.RewardType.Fiexd:(s.rewardType,t.RewardType.Percent)},createTask(e){console.log(e),this.tasks.push({id:this.counter++,username:!1,branchid:1,description:"",finishtime:"",deadline:(new Date).toISOString().slice(0,10),publishtime:"0001-01-01T00:00:00",fixedReward:0,percentReward:0,rewardtype:this.rewardType(e.item.id),status:t.TaskStatus.WaitForAccept,title:"",branchid:e.item.id,verify:0,canTake:1,main:0})},updateTask(e,t){console.log("updateTask triggered",e,t),console.log(this.tasks);let s=this.tasks.findIndex((t=>t.id===parseInt(e)));console.log(s),-1!==s&&(this.tasks[s].description=t.html,this.$refs["id"+e][0].updateT(t))},afterPublish(e){this.tasks=[]},removeTask(e){let t=this.tasks.findIndex((t=>t.id===parseInt(e)));this.tasks.splice(t,1)}},mounted(){console.log(this.$refs)},onShow(){console.log(this.$refs)}};if(!Array){(e.resolveComponent("uni-nav-bar")+e.resolveComponent("taskCard")+e.resolveComponent("uni-fab"))()}Math||((()=>"../../uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar.js")+(()=>"../../components/taskCard/taskCard.js")+(()=>"../../uni_modules/uni-fab/components/uni-fab/uni-fab.js"))();const a=e._export_sfc(s,[["render",function(t,s,a,i,r,o){return e.e({a:e.o(o.backEvent),b:e.o(o.submitEvent),c:e.p({"left-icon":"left",leftText:"返回",rightText:"发布",title:"内容编辑",backgroundColor:"#f8f8f8"}),d:e.f(r.tasks,((t,s,a)=>({a:e.sr("id"+t.id,"9360021c-1-"+a,{f:1}),b:t.id,c:"id"+t.id,d:e.o(o.checkResult,t.id),e:e.o(o.removeTask,t.id),f:"9360021c-1-"+a,g:e.p({task:t,editable:!0})}))),e:"mutiple"==o.mode},"mutiple"==o.mode?{f:e.o(o.createTask),g:e.p({horizontal:"right",content:o.taskTypes,showProp:"name"})}:{})}]]);wx.createPage(a);
