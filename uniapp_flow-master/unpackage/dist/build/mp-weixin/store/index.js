"use strict";const e=require("../common/vendor.js"),s=require("../common/storageKeys.js"),t=require("./messages.js"),a=require("./reference.js"),o=require("../common/signalr.js"),n="https://www.liusha-gy.com",r=e.createStore({state:{$hasLogin:!1,$userName:"未登录",useravatar:"/static/meactive.png",branchs:[],currentTask:{},taskTypes:[],apiBaseUrl:n,tasks:new Map,workSocket:e.markRaw((new o.HubConnectionBuilder).withUrl(n+"/chathub").withAutomaticReconnect().configureLogging(o.LogLevel.Error).build()),messages:new Map,$currentContent:{},$publishResults:[]},mutations:{setCurrentTask(e,s){e.currentTask=s},updateBranchs(s,t){console.log("branchs:",t),void 0!==t&&(s.branchs=e.toRaw(t))},updateTaskTypes(s,t){if(console.log("taskTypes:",t),void 0!==t&&(s.taskTypes=e.toRaw(t)),s.tasks.set("全部",[]),"function"==typeof s.taskTypes[Symbol.iterator])for(let e of s.taskTypes)s.tasks.set(e.name,[])},setTasks(e,s){if(console.log("tasks:",s),void 0!==s){let t=s.taskTypeName;e.tasks.set(t,s.data)}},updateTasks(e,s){if(console.log("tasks:",s),void 0!==s){let t=s.taskTypeName;e.tasks.get(t).push(...s.data)}},updateTaskById(s,t){let a=null;for(let[e,o]of s.tasks)for(let s of o)if(s.id===parseInt(id)){a=s;break}if(null!=a){let o=s.apiBaseUrl+"/api/Assignment/"+t;e.index.requestWithCookie({url:o,success:e=>{200===e.statusCode&&(a=e.data)}})}},updateLocalTask(e){for(let s of $publishs)if(s.id===parseInt(e.id))break},login(t){e.index.setStorageSync(s.StorageKeys.hasLogin,!0),t.$hasLogin=!0},loginOut(t){e.index.setStorageSync(s.StorageKeys.hasLogin,!1),t.$hasLogin=!1},setUserName(t,a){t.$userName=a,e.index.setStorageSync(s.StorageKeys.userName,a)},setUserAvatar(t,a){t.useravatar=t.apiBaseUrl+a,e.index.setStorageSync(s.StorageKeys.userAvatar,t.apiBaseUrl+a)},initUserInfo:t=>{try{const a=e.index.getStorageSync(s.StorageKeys.userName);t.$userName=a}catch(a){console.error(a)}},initHasLogin:t=>{let a=!1;try{a=e.index.getStorageSync(s.StorageKeys.hasLogin)}catch(o){a=!1,console.error(o)}t.$hasLogin=a},loginTest:t=>(e.index.requestWithCookie({url:t.apiBaseUrl+"/api/Account/loginTest",method:"HEAD",success:t=>{200===t.statusCode?e.index.setStorageSync(s.StorageKeys.hasLogin,!0):e.index.setStorageSync(s.StorageKeys.hasLogin,!1)}}),!1),setEditContent(e,s){e.$currentContent=s},setPublishResults(e,s){void 0!==s&&(e.$publishResults=s)},updatePublishResults(e,s){console.log("call"),"function"==typeof s.func?s.func.call(e.$publishResults,s.data):console.error("Invalid input")},clearStorageInfo(t){e.index.removeStorageSync(s.StorageKeys._hasLogin),e.index.removeStorageSync(s.StorageKeys._userName),e.index.removeStorageSync(s.StorageKeys.__cookie_store__),e.index.removeStorageSync(s.StorageKeys._task_content)},disconnect(e){e.workSocket.stop()}},getters:{getTasks:e=>s=>e.tasks.get(s),getTaskById:e=>s=>{let t=null;for(let[a,o]of e.tasks)for(let e of o)if(e.id===parseInt(s)){t=e;break}if(null!=t)return t},getBranch:e=>s=>{let t=e.branchs.find((e=>e.id===parseInt(s)));return console.log("branch is: ",t),void 0===t?"部门":t.name},getTaskType:e=>s=>{let t=e.taskTypes.find((e=>e.id===parseInt(s)));return console.log("taskType is: ",t),void 0===t?{id:0,name:"类型",rewardType:"all"}:t},getBranchIndex:e=>s=>{let t=e.branchs.findIndex((e=>e.id===s));return void 0===t?0:t},getMessages:e=>s=>e.messages.get(parseInt(s)),currentEditContent:e=>e.$currentContent,publishResults:e=>e.$publishResults,hasLogin:t=>(t=1)=>{let a;try{a=e.index.getStorageSync(s.StorageKeys.hasLogin)}catch(o){a=!1,console.error(o)}return a}},actions:{async fetchBranchs({commit:s,state:t}){try{await e.index.requestWithCookie({url:t.apiBaseUrl+"/api/Information/branchs",method:"GET",complete(){},success:function(e){console.log(e);let t=e.data;s("updateBranchs",t)}})}catch(a){console.error("fetch branchs error:",a)}},fetchTaskTypes:async({commit:s,state:t})=>new Promise(((s,a)=>{e.index.requestWithCookie({url:t.apiBaseUrl+"/api/Information/customtypes",method:"GET",complete(){},success:function(e){console.log(e);let t=e.data;s(t)}})})),fetchTasks:({commit:s,state:t},{count:a,offset:o,branchid:n})=>new Promise(((s,r)=>{e.index.requestWithCookie({url:t.apiBaseUrl+"/api/Assignment?count="+a+"&offset="+o+"&branchid="+n,method:"GET",success:e=>{console.log(e);let t=e.data;s(t)},fail:e=>{r(e)}})})),async fetchTaskById({commit:s},t){let a=state.apiBaseUrl+"/api/Assignment/"+t;try{await e.index.requestWithCookie({url:a,method:"GET",success:function(t){console.log(t);let a=t.data;e.nextTick$1((()=>{s("setTasks",a)}))}})}catch(o){console.error("fetch tasks error:",o)}},async sendMsg({commit:e,state:s},{user:t,message:a}){await s.workSocket.invoke("SendToUser",t,a),console.log("sendMsg");let o=parseInt(t);void 0===s.messages.get(o)&&s.messages.set(o,new Array),s.messages.get(o).push({isLeft:!1,content:a})},receiveMsg({commit:e,state:s,dispatch:t},{user:a,message:o}){console.log("receiveMsg");let n=parseInt(a);o.cid=n,void 0===s.messages.get(n)&&s.messages.set(n,new Array),o.isLeft=!0,s.messages.get(n).push(o),t("Msgs/updateAsync",o)},async connect({state:e,actions:s}){await async function s(){try{await e.workSocket.start(),console.log("SignalR Connected.")}catch(t){console.log(t),setTimeout(s,5e3)}}()},genHistory({state:s},t){let a=s.apiBaseUrl+"/api/History";e.index.uploadFileWithCookie({url:a,filePath:"123",name:"123",formData:{asgid:t},success:e=>{console.log(e)}})},upload:({state:s})=>new Promise(((t,a)=>{e.index.showActionSheet({itemList:["从相册选择","拍照"],success:o=>{console.log(o),0===o.tapIndex&&e.index.chooseImage({count:1,crop:{with:800,height:800},success:a=>{console.log(a),a.tempFiles[0].size>2097152?e.index.showToast({title:"图片大小超过2M,请重新选择。"}):e.index.uploadFile({name:"user-avatar",filePath:a.tempFilePaths[0],url:s.apiBaseUrl+"/api/Image/upload",success:e=>{t(e)},fail:e=>{}})},fail:e=>{a(e)}}),o.tapIndex}})}))},modules:{Msgs:t.Messages,Refer:a.References}});exports.store=r;
